@page "/blog/{Id:int}"
@page "/blog/{Id:int}/{type}"

@implements IDisposable

@inject BlogService BlogDataService

<BSPagination Class="paging fixed-top mx-5">
    <BSPaginationItem IsDisabled="@(Previous == null ? true : false)">
        <BSPaginationLink PaginationLinkType="PaginationLinkType.PreviousText" Href="@GetUrl("Previous")" />
    </BSPaginationItem>
    <BSPaginationItem IsDisabled="@(Next == null ? true : false)">
        <BSPaginationLink PaginationLinkType="PaginationLinkType.NextText" Href="@GetUrl("Next")" />
    </BSPaginationItem>
</BSPagination>

<base href="~/" />
<h3 class="ml-5">@Blog.Title</h3>
<small class="ml-5">@Blog.DateAdded.ToString("dd MMMM yyyy")</small>
<div class="m-5">
    @((MarkupString)Blog.Post)
</div>

<BSPagination>
    <BSPaginationItem IsDisabled="@(Previous == null ? true : false)">
        <BSPaginationLink PaginationLinkType="PaginationLinkType.PreviousText" Href="@GetUrl("Previous")" />
    </BSPaginationItem>
    <BSPaginationItem IsDisabled="@(Next == null ? true : false)">
        <BSPaginationLink PaginationLinkType="PaginationLinkType.NextText" Href="@GetUrl("Next")" />
    </BSPaginationItem>
</BSPagination>

@code {
    [Parameter]
    public int Id { get; set; }
    [Parameter]
    public string Type { get; set; }
    private Blog Blog;
    private int? Next;
    private int? Previous;

    protected override void OnInitialized() {
        SetUpNextAndPrevious();
        NavManager.LocationChanged += OnLocationChanges;
    }

    private void SetUpNextAndPrevious() {
        var nextPrevious = BlogDataService.GetBlogNextAndPrevious(Id, Type);
        Next = nextPrevious[0];
        Previous = nextPrevious[1];
        Blog = BlogDataService.GetBlogFull(Id);
        StateHasChanged();
    }

    private string GetUrl(string direction) {
        var index = "";
        if (direction == "Next" && Next != null)
            index = "/" + Next;
        else if (direction == "Previous" && Previous != null)
            index = "/" + Previous;
        var type = "";
        if (Type != null)
            type = "/" + Type;
        return "/blog" + index + type;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        await JSRuntime.InvokeAsync<string>("PR.prettyPrint");
    }

    public void Dispose() {
        NavManager.LocationChanged -= OnLocationChanges;
    }

    private void OnLocationChanges(object sender, LocationChangedEventArgs e) => SetUpNextAndPrevious();

}
